{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Группа {{ subgroup.subgroup_name }}</title>
    <link rel="stylesheet" href="{% static 'adminpages/css/table_students.css' %}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>  
    
    <style>
        .table-bordered {
            border-collapse: collapse;
            border: 2px solid black;
            border-top: 2px solid black;
        }
        .table-bordered td,
        .table-bordered th,
        .table-bordered tr {
            border-right: 2px solid black;
            border-top: 2px solid black;
        }

        .border-bottom {
            border-bottom: 2px solid black;
            border-top: 2px solid black;
        }

        .table-bordered td:nth-child(2n) {
            border-top: 2px solid black;
            border-right: 0px solid black;
        }

        .container.rounded {
            border: 2px solid #8B2222;
            background-color: #FBE4C5;
            border-radius: 10px;
            padding: 15px;
        }
        
        .container.rounded-main {
            border: 2px solid #8B2222;
            padding: 15px;
            background-color: #FBE4C5;
        }

        #searchResultsContainer {
            max-height: 30px;
            overflow-y: auto;
        }

        .btn-primary {
            background-color: #8B2222 !important;
            border-color: #8B2222 !important;
        }

        .btn-primary:not(:disabled):not(.disabled):active,
        .btn-primary:not(:disabled):not(.disabled).active,
        .show>.btn-primary.dropdown-toggle {
            color: #ffffff !important;
        }

        .btn-primary:hover {
            background-color: #A84242 !important;
            border-color: #A84242 !important;
        }

        .comment-z {
            position: relative;
        }

        .comment-z::after {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-top: 10px solid transparent;
            border-bottom: 20px solid #000;
            border-right: -10px solid transparent;
        }
    </style>
</head>

<body>
    <div id="uniqueContainer" class="container rounded-main" style="max-width: 100%;">
        <div class="row">
            <div class="col-md-6 text-left">
                <div class="row">
                    <div class="col-md-2">
                        <a href="{% url 'index_admin' %}" class="btn btn-primary btn-lg" style="white-space: nowrap;">На главную</a>
                    </div>
                    <div class="col-md-2" style="margin-left: 180px;">
                        <a href="{% url 'subgroups_select_admin' subgroup.key_group.id_groups_table %}" class="btn btn-primary btn-lg" style="white-space: nowrap;">К списку групп</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <div style="text-align: center;">
        <img src="{% static 'adminpages/icons/chelgu-logo.png' %}" alt="logo" style="max-width: 130px; max-height: 130px; margin-top: -4%;">
    </div>
    
    <div class="container" style="width: 100%; max-width: none; margin-top: 10px; max-height: 700px; overflow-y: auto;">
        <table class="table table-bordered">
            <thead>
                <tr class="border-bottom">
                    <th rowspan="2" class="subgroup-header border-bottom">{{ subgroup.subgroup_name }}</th>

                    {% for week in weeks %}
                        <th colspan="2" style="{{ week.color }}" class="border-bottom">
                            <button class="btn btn-primary lock" data-week-lock="{{ week.id_weeks_table }}" onclick="handleLockButtonClick('{{ week.id_weeks_table }}')">
                                <img src="{% static 'adminpages/icons/lock.svg' %}" alt="logo" style="width: 35px; height: 35px; display: inline-block; vertical-align: middle;">
                            </button>
                            <div>{{week.week_name}}</div>
                        </th>
                    {% endfor %}
                </tr>
                <tr class="border-bottom">
                    {% for month_info in month_data %}
                        <th colspan="{{ month_info.month_span }}" class="month-header border-bottom">{{ month_info.month_name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="dataTable">
                <tr>
                    <td>ФИО Студента</td>
                    {% for week in weeks %}
                        <td>По уважительной</td>
                        <td>По неуважительной</td>
                    {% endfor %}
                </tr>
                {% for data in attendance_data %}
                <tr>
                    <td style="white-space: nowrap;">{{ data.student.student_name }}</td>
                    {% for week, att in data.attendance.items %}
                        <td class="normal-border" data-respectfully="По уважительной" data-id-student="{{data.student.id_students_table}}" data-name-student="{{data.student.student_name}}" data-week="{{week}}" data-comment="{{att.comment}}" data-color="{{att.color}}">{{ att.attendance_respectfully|default_if_none:"" }}</td>
                        <td class="normal-border" data-respectfully="По неуважительной" data-id-student="{{data.student.id_students_table}}" data-name-student="{{data.student.student_name}}" data-week="{{week}}" data-comment="{{att.comment}}" data-color="{{att.color}}">{{ att.attendance_disrespectfully|default_if_none:"" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="button-container" style="display: block; clear: both; margin-right: 15px; margin-top: 20px; margin-left: 20px;">
        <button id="collectButton" class="btn btn-primary btn-lg">Сохранить</button>
    </div> 

    <div id="AnswerModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="AnswerModalTitle">Данные месяца</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">

                </div>
            </div>
        </div>
    </div>

    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000" style="position: fixed; bottom: 10px; right: 10px;">
        <div class="toast-header">
            <strong class="mr-auto">Ошибка</strong>
            <small class="text-muted">Только что</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close" onclick="window.location.reload()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body">
            <span id="toastMessage">Ошибка при сохранении данных.</span>
        </div>
    </div>
    
      
    <div class="modal" id="cellModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Данные студента</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <label for="cellValue">Новое значение:</label>
                    <input type="text" id="cellValue" class="form-control stretched-input" placeholder="Значение">
                    <br>
                    <label for="cellComment">Комментарий (не более 200 символов):</label>
                    <textarea id="cellComment" class="form-control stretched-input" maxlength="200" placeholder="Комментарий"></textarea>
                    <div id="colorPickerContainer">
                        <div class='hexColorPicker'>
                            <div id='output' class='noselect'></div>
                        </div>
                    </div>
                        <script>
                            const allColors=['#003366','#336699','#3366CC','#003399','#000099','#0000CC','#000066','#006666','#006699','#0099CC','#0066CC','#0033CC','#0000FF','#3333FF','#333399','#669999','#009999','#33CCCC','#00CCFF','#0099FF','#0066FF','#3366FF','#3333CC','#666699','#339966','#00CC99','#00FFCC','#00FFFF','#33CCFF','#3399FF','#6699FF','#6666FF','#6600FF','#6600CC','#339933','#00CC66','#00FF99','#66FFCC','#66FFFF','#66CCFF','#99CCFF','#9999FF','#9966FF','#9933FF','#9900FF','#006600','#00CC00','#00FF00','#66FF99','#99FFCC','#CCFFFF','#CCCCFF','#CC99FF','#CC66FF','#CC33FF','#CC00FF','#9900CC','#003300','#009933','#33CC33','#66FF66','#99FF99','#CCFFCC','#FFFFFF','#FFCCFF','#FF99FF','#FF66FF','#FF00FF','#CC00CC','#660066','#336600','#009900','#66FF33','#99FF66','#CCFF99','#FFFFCC','#FFCCCC','#FF99CC','#FF66CC','#FF33CC','#CC0099','#993399','#333300','#669900','#99FF33','#CCFF66','#FFFF99','#FFCC99','#FF9999','#FF6699','#FF3399','#CC3399','#990099','#666633','#99CC00','#CCFF33','#FFFF66','#FFCC66','#FF9966','#FF6666','#FF0066','#CC6699','#993366','#999966','#CCCC00','#FFFF00','#FFCC00','#FF9933','#FF6600','#FF5050','#CC0066','#660033','#996633','#CC9900','#FF9900','#CC6600','#FF3300','#FF0000','#CC0000','#990033','#663300','#996600','#CC3300','#993300','#990000','#800000','#993333'];
                            const hexUnicode='⬢';
                            var n=0;
                            var hexNums=[7, 8, 9, 10, 11, 12];
                            var hexArrs=[];
                            var hexNum;
                            for(hexNum of hexNums) {
                                hexArr=[];
                                for(n=0;n<hexNum;n++) hexArr.push(hexUnicode);
                                hexArrs.push(hexArr);
                            }
                            hexArr=[];
                            for(n=0;n<13;n++) hexArr.push(hexUnicode);
                            hexArrs.push(hexArr);
                            hexArr=[];
                            var hexNums2=JSON.parse(JSON.stringify(hexNums));
                            hexNums2.reverse();
                            for(hexNum of hexNums2) {
                                hexArr=[];
                                for(n=0;n<hexNum;n++) hexArr.push(hexUnicode);
                                hexArrs.push(hexArr);
                            }
                            var output=document.getElementById("output");
                            for(var hexArrLine of hexArrs) {
                                var hexLine='<span class="colorHex">'+hexArrLine.join('</span><span class="colorHex">') + '</span>';
                                output.insertAdjacentHTML('beforeend', '<span class="condensed-line">'+hexLine+'</span>');
                            }
                        
                            const hexToRGB = (hex) => {
                              let h = hex.slice(hex.startsWith('#') ? 1 : 0);
                              if (h.length === 3) h = [...h].map(x => x + x).join('');
                              h = parseInt(h, 16);
                              return {
                                  'r': (h >>> 16),
                                  'g': ((h & 0x00ff00) >>> 8),
                                  'b': ((h & 0x0000ff) >>> 0)
                              };
                            };
                        
                            function copyToClipboard(inputEleId) {
                               let copyText = document.getElementById(inputEleId);
                               navigator.clipboard.writeText(copyText.value);
                            }
                        
                            var copyBtns=document.getElementsByClassName("copyBtn");
                            for(var copyBtn of copyBtns) {
                                copyBtn.addEventListener('click', (evt) => {
                                    copyToClipboard(evt.target.value);
                                }, false);
                            }
                        
                            var hexInputVal=document.getElementById('hexInputVal');
                        
                            var rInputVal=document.getElementById('rInputVal');
                            var gInputVal=document.getElementById('gInputVal');
                            var bInputVal=document.getElementById('bInputVal');
                        
                            var rgbInputVal=document.getElementById('rgbInputVal');
                        
                            var selectedHexColor=document.getElementById('selectedHexColor');
                            var selectedRgbColor=document.getElementById('selectedRgbColor');
                        
                            var colorHexs=document.getElementsByClassName('colorHex');
                            var h=0;
                            for(var colorHex of colorHexs) {
                                colorHex['style']['webkit-text-fill-color']=allColors[h];
                                colorHex['style']['color']=allColors[h];
                                colorHex['style']['-webkit-text-stroke']='3.75px '+allColors[h];
                        
                                colorHex.setAttribute('data-hex',allColors[h]);
                                let rgbObj=hexToRGB(allColors[h]);
                                colorHex.setAttribute('data-r',  rgbObj['r']);
                                colorHex.setAttribute('data-g',  rgbObj['g']);
                                colorHex.setAttribute('data-b',  rgbObj['b']);
                        
                                colorHex.addEventListener('click', (evt) => {
                                    let hexSrcElement=evt.srcElement;
                        
                                    let selectedColorHex=document.getElementsByClassName('color-selected');
                                    if(selectedColorHex.length>0) {
                                        selectedColorHex[0].classList.remove('color-selected');
                                    }
                                    hexSrcElement.classList.add('color-selected');
                        
                                    let dataset=hexSrcElement.dataset;
                                    let hexVal=dataset.hex;
                                    hexInputVal.value=hexVal.toLowerCase();
                                    selectedHexColor['style']['background']=hexVal;
                        
                                    let rVal=dataset['r'];
                                    let gVal=dataset['g'];
                                    let bVal=dataset['b'];
                                    rInputVal.value=rVal;
                                    gInputVal.value=gVal;
                                    bInputVal.value=bVal;
                                    let rgbVal=`rgb(${rVal}, ${gVal}, ${bVal})`;
                                    rgbInputVal.value=rgbVal;
                                    selectedRgbColor['style']['background']=rgbVal;
                                }, false);
                                h++;
                            }
                            colorHexs[63].click();
                        </script>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="applyChanges()">Применить</button>
                </div>
            </div>
        </div>
    </div>    

    <script>
        var accessWeeks = [
            {% for access in AccessWeeks %}
                "{{ access.week.id_weeks_table }}",
            {% endfor %}
        ];
        function updateLockButtons() {
            var lockButtons = document.querySelectorAll('.btn[data-week-lock]');
            lockButtons.forEach(function(button) {
                var weekId = button.getAttribute('data-week-lock');
                var hasAccess = accessWeeks.includes(weekId);
                if (hasAccess) {
                    button.innerHTML = '<object type="image/svg+xml" data="{% static "adminpages/icons/unlock.svg" %}" style="width: 35px; height: 35px; display: inline-block; vertical-align: middle;"></object>';
                } else {
                    button.innerHTML = '<object type="image/svg+xml" data="{% static "adminpages/icons/lock.svg" %}" style="width: 35px; height: 35px; display: inline-block; vertical-align: middle;"></object>';
                }
            });
        }

        function addColorIndicator() {
            var tdElements = document.querySelectorAll('td[data-color]');
            tdElements.forEach(function(td) {
                var color = td.getAttribute('data-color');
                if (color.trim() !== '') {
                    td.style.backgroundColor = color;
                    td.style.backgroundColor = 'rgba(' + parseInt(color.slice(-6, -4), 16)
                        + ',' + parseInt(color.slice(-4, -2), 16)
                        + ',' + parseInt(color.slice(-2), 16)
                        + ',0.5)';
                }
            });
        }

        function findCommentIndicator() {
            var tdCommentElements = document.querySelectorAll('td[data-comment]');
                
            tdCommentElements.forEach(function(td) {
                td.addEventListener('mouseenter', function(event) {
                    var comment = td.getAttribute('data-comment');
                    if (comment.trim() !== '' && comment.trim() !== 'None') {
                        var mousePosX = event.pageX;
                        var mousePosY = event.pageY;
                        showToast(comment, mousePosX, mousePosY);
                    }
                });

                td.addEventListener('mouseleave', function() {hideToast();});
            });
        }

        function showToast(comment, posX, posY) {
            var toastElement = document.createElement('div');
            toastElement.id = 'commentToast';
            toastElement.classList.add('toast');
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.setAttribute('data-delay', '5000');
            toastElement.style.position = 'absolute';
            toastElement.style.left = posX + 'px';
            toastElement.style.top = posY + 'px';
            toastElement.innerHTML = `
                <div class="toast-header">
                    <strong class="mr-auto">Комментарий</strong>
                    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="toast-body">
                    ${comment}
                </div>
            `;
            document.body.appendChild(toastElement);
            $(toastElement).toast('show');
        }

        function hideToast() {
            var toastElement = document.getElementById('commentToast');
            if (toastElement) {
                $(toastElement).toast('hide');
                toastElement.remove();
            }
        }

        function addCommentIndicator() {
            var tdElements = document.querySelectorAll('td[data-comment]');
            tdElements.forEach(function(td) {
                var comment = td.getAttribute('data-comment');
                if (comment.trim() !== '' && comment.trim() !== 'None') {td.classList.add('comment-z');}
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            addColorIndicator();
            findCommentIndicator();
            updateLockButtons();
            addCommentIndicator()
        });

        function applyChanges() {
            var newValue = document.getElementById('cellValue').value;
            var newComment = document.getElementById('cellComment').value;
            var selectedCell = document.querySelector('.table-bordered tbody td.selected');
            var selectedColor = document.querySelector('.color-selected').dataset.hex;
            if (selectedCell) {
                selectedCell.innerText = newValue;
                var respectType = selectedCell.getAttribute('data-respectfully');
                var siblingCell;
                if (respectType === "По уважительной") {
                    siblingCell = selectedCell.nextElementSibling || selectedCell.previousElementSibling;
                } else {
                    siblingCell = selectedCell.previousElementSibling || selectedCell.nextElementSibling;
                }
                selectedCell.setAttribute('data-comment', newComment);
                siblingCell.setAttribute('data-comment', newComment);

                selectedCell.style.backgroundColor = selectedColor;
                selectedCell.style.backgroundColor = 'rgba(' + parseInt(selectedColor.slice(-6, -4), 16)
                        + ',' + parseInt(selectedColor.slice(-4, -2), 16)
                        + ',' + parseInt(selectedColor.slice(-2), 16)
                        + ',0.5)';
                siblingCell.style.backgroundColor = selectedColor;
                siblingCell.style.backgroundColor = 'rgba(' + parseInt(selectedColor.slice(-6, -4), 16)
                        + ',' + parseInt(selectedColor.slice(-4, -2), 16)
                        + ',' + parseInt(selectedColor.slice(-2), 16)
                        + ',0.5)';
                var tdCommentElements = document.querySelectorAll('td[data-comment]');
                tdCommentElements.forEach(function(td) {
                    if (td.getAttribute('data-comment').trim() !== '') {
                        var comment = td.getAttribute('data-comment');
                        if (comment.trim() !== '' && comment.trim() !== 'None') {td.classList.add('comment-z');}
                    } else {
                        td.classList.remove('comment-z');
                    }
                });
                
                
            }
            $('#cellModal').modal('hide');
        }

        function handleCellClick() {
            var tableCells = document.querySelectorAll('.table-bordered tbody tr:not(:first-of-type) td:not(:first-child)');


            var weekHeaders = document.querySelectorAll('.table-bordered thead th:not(:first-child)');

            tableCells.forEach(function (cell) {
                cell.addEventListener('click', function () {
                    document.querySelectorAll('.table-bordered tbody td').forEach(function (cell) {
                        cell.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    var cellText = this.innerText;
                    var weekIndex = Array.from(this.parentNode.children).indexOf(this) - 1;
                    var weekHeader = weekHeaders[Math.trunc(weekIndex / 2)];
                    var week = weekHeader.innerText;
                    var studentName = this.getAttribute('data-name-student');
                    var respectfullyInfo = this.getAttribute('data-respectfully');
                    var comment = this.getAttribute('data-comment');
                    document.getElementById('cellValue').value = cellText;
                    document.getElementById('cellComment').value = comment;
                    document.getElementById('modalTitle').innerText = studentName + ', ' + week + ': ' + respectfullyInfo;
                    $('#cellModal').modal('show');
                });
            });
        }

        function handleAnswerModalMonths() {
            var monthHeaders = document.querySelectorAll('.table-bordered thead th.month-header');

            monthHeaders.forEach(function(header) {
                header.addEventListener('click', function() {
                    var monthName = header.innerText;
                    var monthCol = parseInt(header.getAttribute('colspan'));
                    var monthData = getMonthData(monthName, monthCol);
                    var modal = document.getElementById('AnswerModal');

                    var modalBody = modal.querySelector('.modal-body');
                    modalBody.innerHTML = ''; 
                    for (var studentName in monthData) {
                        var studentData = monthData[studentName];
                        var studentElement = document.createElement('div');
                        studentElement.innerHTML = '<strong>' + studentName + '</strong>: По уважительной: ' + studentData.respectfully + ', По неуважительной: ' + studentData.disrespectfully + ', Сумма: ' + studentData.total;
                        modalBody.appendChild(studentElement);
                    }
                    var modalTitle = modal.querySelector('.modal-title');
                    modalTitle.innerText = monthName;
                    applyDynamicModalStyles();
                    $('#AnswerModal').modal('show');
                });
            });
        }

        function getMonthData(monthName, monthCol) {
            var monthData = {};
            var monthHeaders = document.querySelectorAll('.table-bordered thead th.month-header');
            var startIndex = 0;
            for (var i = 0; i < monthHeaders.length; i++) {
                if (monthHeaders[i].innerText === monthName) {
                    break;
                }
                if (monthHeaders[i].getAttribute('colspan')) {
                    startIndex += parseInt(monthHeaders[i].getAttribute('colspan'), 10);
                }
            }
            var tableRows = document.querySelectorAll('.table-bordered tbody tr:not(:first-of-type)');
            tableRows.forEach(function(row) {
                var studentName = row.cells[0].innerText;
                monthData[studentName] = monthData[studentName] || { "respectfully": 0, "disrespectfully": 0, "total": 0 };
                var cells = row.cells;
                var EndIndex = startIndex + monthCol + 1;
                for (var i = startIndex + 1; i < EndIndex; i ++) {
                        var respectfullyType = cells[i].getAttribute('data-respectfully');
                        var respectfullyValue = parseInt(cells[i].innerText || 0);
                        
                        if (respectfullyType === "По уважительной") {
                            monthData[studentName]["respectfully"] += respectfullyValue;
                        } else if (respectfullyType === "По неуважительной") {
                            monthData[studentName]["disrespectfully"] += respectfullyValue;
                        }
                        monthData[studentName]["total"] += respectfullyValue;
                }
            });

            return monthData;
        }

        function handleAnswerModalStudents() {
            var studentNames = document.querySelectorAll('.table-bordered tbody tr:not(:first-of-type) td:first-child');
            studentNames.forEach(function(nameCell) {
                nameCell.addEventListener('click', function() {
                    var studentName = nameCell.innerText;
                    var studentData = getStudentData(studentName);
                    var modal = document.getElementById('AnswerModal');
                    var modalBody = modal.querySelector('.modal-body');
                    modalBody.innerHTML = '';
                    for (var monthName in studentData) {
                        var monthData = studentData[monthName];
                        var studentElement = document.createElement('div');
                        studentElement.innerHTML = '<strong>' + monthName + '</strong>: По уважительной: ' + monthData.respectfully + ', По неуважительной: ' + monthData.disrespectfully + ', Сумма: ' + monthData.total;
                        modalBody.appendChild(studentElement);
                    }
                    var modalTitle = modal.querySelector('.modal-title');
                    modalTitle.innerText = studentName;
                    applyDynamicModalStyles();
                    $('#AnswerModal').modal('show');
                });
            });
        }

        function getStudentData(studentName) {
            var studentData = {};

            var tableRows = document.querySelectorAll('.table-bordered tbody tr');
            
            tableRows.forEach(function(row) {
                var name = row.cells[0].innerText;
                if (name === studentName) {
                    var cells = row.cells;

                    var monthHeaders = document.querySelectorAll('.table-bordered thead th.month-header');
                    monthHeaders.forEach(function(header) {
                        var monthName = header.innerText;
                        var monthCol = parseInt(header.getAttribute('colspan'));
                        var startIndex = 0;
                        for (var i = 0; i < monthHeaders.length; i++) {
                            if (monthHeaders[i].innerText === monthName) {
                                break;
                            }
                            if (monthHeaders[i].getAttribute('colspan')) {
                                startIndex += parseInt(monthHeaders[i].getAttribute('colspan'), 10);
                            }
                        }
                        var endIndex = startIndex + monthCol;

                        for (var i = startIndex + 1; i <= endIndex; i ++) {
                            var weekMonth = cells[i].getAttribute('data-week');
                            var respectfullyType = cells[i].getAttribute('data-respectfully');
                            var respectfullyValue = parseInt(cells[i].innerText || 0);

                            if (studentData[monthName] === undefined) {
                                studentData[monthName] = { "respectfully": 0, "disrespectfully": 0, "total": 0 };
                            }

                            if (respectfullyType === "По уважительной") {
                                studentData[monthName]["respectfully"] += respectfullyValue;
                            } else if (respectfullyType === "По неуважительной") {
                                studentData[monthName]["disrespectfully"] += respectfullyValue;
                            }
                            studentData[monthName]["total"] += respectfullyValue;
                        }
                    });
                }
            });

            return studentData;
        }

        function handleAnswerModalSubgroups() {
            var subgroupHeaders = document.querySelectorAll('.subgroup-header');

            subgroupHeaders.forEach(function(header) {
                header.addEventListener('click', function() {
                    var subgroupName = header.innerText;
                    var subgroupData = getSubgroupData(subgroupName);
                    var modal = document.getElementById('AnswerModal');
                    var modalBody = modal.querySelector('.modal-body');
                    modalBody.innerHTML = '';
                    for (var studentName in subgroupData) {
                        var studentData = subgroupData[studentName];
                        var studentElement = document.createElement('div');
                        studentElement.innerHTML = '<strong>' + studentName + '</strong>: По уважительной: ' + studentData.respectfully + ', По неуважительной: ' + studentData.disrespectfully + ', Сумма: ' + studentData.total;
                        modalBody.appendChild(studentElement);
                    }
                    var modalTitle = modal.querySelector('.modal-title');
                    modalTitle.innerText = subgroupName;
                    applyDynamicModalStyles();
                    $('#AnswerModal').modal('show');
                });
            });
        }

        function getSubgroupData(subgroupName) {
            var subgroupData = {};

            var tableRows = document.querySelectorAll('.table-bordered tbody tr:not(:first-of-type)');

            tableRows.forEach(function(row) {
                var cells = row.cells;
                var studentName = cells[0].innerText;
                for (var i = 1; i < cells.length; i++) {
                    var respectfullyType = cells[i].getAttribute('data-respectfully');
                    var respectfullyValue = parseInt(cells[i].innerText || 0);
                    if (subgroupData[studentName] === undefined) {subgroupData[studentName] = { "respectfully": 0, "disrespectfully": 0, "total": 0 };}
                    if (respectfullyType === "По уважительной") 
                        {subgroupData[studentName]["respectfully"] += respectfullyValue;
                            } else if (respectfullyType === "По неуважительной") {
                                subgroupData[studentName]["disrespectfully"] += respectfullyValue;
                            }
                            subgroupData[studentName]["total"] += respectfullyValue;
                }
                
            });
            return subgroupData;
        }

        function applyDynamicModalStyles() {
            var modalContent = document.querySelector('#AnswerModal .modal-content');
            var modalBodyDivs = document.querySelectorAll('#AnswerModal .modal-body div');
            var tempElement = document.createElement('span');
            tempElement.style.visibility = 'hidden';
            tempElement.style.position = 'absolute';
            document.body.appendChild(tempElement);
            var maxWidth = 0;
            modalBodyDivs.forEach(function(div) {
                tempElement.innerText = div.innerText;
                var textWidth = tempElement.getBoundingClientRect().width;
                maxWidth = Math.max(maxWidth, textWidth) + 20;
            });
            document.body.removeChild(tempElement);
            modalContent.style.width = (maxWidth + 20) + 'px';
        }

        document.addEventListener('DOMContentLoaded', function () {
            handleCellClick()
            handleAnswerModalMonths()
            handleAnswerModalStudents()
            handleAnswerModalSubgroups()
        });

        function handleLockButtonClick(week) {
                var lockBtn = $(event.target);
                $.ajax({
                        type: "POST",
                        url: "add_lock/",
                        data: {
                            'week': week,
                            'key_subgroup': '{{ subgroup.id_subgroups_table }}',
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.success) {
                                var dataAttr = lockBtn.find("object").attr("data");
                                if (dataAttr.indexOf("{% static 'adminpages/icons/lock.svg' %}") !== -1) {
                                    lockBtn.find("object").attr("data", "{% static 'adminpages/icons/unlock.svg' %}");
                                } else {
                                    lockBtn.find("object").attr("data", "{% static 'adminpages/icons/lock.svg' %}");
                                }
                            } else {
                                alert("Ошибка при добавлении: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error(xhr.responseText);
                        }
                    });
            }

        $('#collectButton').click(function() {
            var dataArray = [];
            var attendanceArray = [];
            $('#dataTable tr').slice(1).each(function(index, row) {
                var cells = $(row).find('td');
                for (var i = 1; i < cells.length; i += 2) {
                        var id_student = $(cells[i]).data('id-student');
                        var id_week = $(cells[i]).data('week');
                        var comment = $(cells[i]).data('comment');
                        var color = $(cells[i]).css('background-color');
                        var attendance_respectfully = $(cells[i]).text();
                        var attendance_disrespectfully = $(cells[i+1]).text();

                        var rowData = {
                            'student_id': id_student,
                            'comment': comment,
                            'color': color,
                            'week_id': id_week
                        };

                        var attendanceData = {
                            'student_id': id_student,
                            'attendance_respectfully': attendance_respectfully,
                            'attendance_disrespectfully': attendance_disrespectfully,
                            'week_id': id_week
                        }     
                        dataArray.push(rowData); 
                        attendanceArray.push(attendanceData);
                }
            });
            $.ajax({
                type: "POST",
                url: "save_table/",
                data: {
                    'dataAttendance': JSON.stringify(attendanceArray),
                    'dataComments': JSON.stringify(dataArray),
                    'subgroup': '{{ subgroup.id_subgroups_table }}',
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        window.location.href = "{% url 'subgroups_select_admin' subgroup.key_group.id_groups_table %}?success=true";
                    } else {
                        
                        $('#toastMessage').text("Ошибка при сохранении данных: " + response.message);
                        $('#errorToast').toast('show');
                        setTimeout(function() {
                            window.location.reload();
                        }, 3000);
                    }
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        });


        $(document).ready(function() {
        $(document).on('mousedown', '#dataTable td[data-respectfully]', function(e) {
            const respectfully = $(this).data('respectfully');
            if (e.which === 3 && (respectfully === "По уважительной" || respectfully === "По неуважительной")) {
                let $cell = $(this);
                let $nextCell, $prevCell;
                if (respectfully === "По уважительной") {
                    $nextCell = $cell.next('td[data-respectfully="По неуважительной"]');
                } else {
                    $prevCell = $cell.prev('td[data-respectfully="По уважительной"]');
                }
                if ($nextCell && $nextCell.length) {
                    moveValue($cell, $nextCell);
                } else if ($prevCell && $prevCell.length) {
                    moveValue($cell, $prevCell);
                }
            }
        });

        $(document).on('contextmenu', '#dataTable td[data-respectfully]', function(e) {
            if (e.which === 3) {
                e.preventDefault();
            }
        });

        function moveValue($fromCell, $toCell) {
            let fromValue = $fromCell.text();
            let toValue = $toCell.text();

            $fromCell.text(toValue);
            $toCell.text(fromValue);
        }
    });

    </script>
</body>
</html>